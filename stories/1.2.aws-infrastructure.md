# Story 1.2: AWS Infrastructure Setup (S3, API Gateway, Core Services)

**Status:** Ready for Development

---

## Story

**As a** DevOps Engineer,
**I want** to provision AWS infrastructure for object storage, API routing, and foundational services,
**so that** backend services have scalable storage, API gateway for request routing and authentication, and monitoring capabilities ready for application deployment.

---

## Acceptance Criteria

1. S3 bucket created for photo storage with versioning enabled, bucket encryption (AES-256), and lifecycle policies
2. S3 bucket configured with CORS rules to allow photo uploads from mobile/web clients
3. API Gateway (AWS API Gateway or Kong) set up with JWT token validation, rate limiting, and request/response logging
4. CloudWatch log groups created for all services: API Gateway, Lambda, ECS services
5. IAM roles and policies created for: S3 bucket access, CloudWatch logging, API Gateway invocation
6. VPC and subnets configured with proper security groups and network isolation
7. ElastiCache Redis cluster provisioned for caching (development can use standalone Redis)
8. Terraform configuration files created and version controlled for infrastructure reproducibility

---

## Dev Notes

### AWS Architecture Overview
- **Object Storage**: AWS S3 for photo storage with direct upload capability via pre-signed URLs [Source: architecture.md#4.3-Photo-Upload-Service]
- **API Gateway**: AWS API Gateway with JWT authentication, rate limiting, request routing to backend microservices [Source: architecture.md#4.2-API-Gateway]
- **Caching Layer**: Redis (ElastiCache in AWS) for distributed caching of detection results and metadata [Source: architecture.md#4.2-API-Gateway]
- **Logging & Monitoring**: CloudWatch for logs, CloudWatch Metrics for monitoring, X-Ray for tracing [Source: architecture.md#11-Monitoring-and-Observability]
- **Infrastructure as Code**: Terraform for provisioning and managing AWS resources [Source: architecture.md#10.2-Infrastructure-as-Code]

### S3 Configuration Requirements
- **Bucket Name**: `companycam-photos-{environment}` (e.g., companycam-photos-dev, companycam-photos-prod)
- **Versioning**: Enabled for data protection and rollback capability
- **Encryption**: AES-256 (server-side encryption)
- **Lifecycle Policies**:
  - Move to Glacier after 90 days for cost optimization
  - Delete temporary artifacts (depth maps, temporary processing files) after 30 days [Source: architecture.md#14.2-Cost-Optimization]
- **CORS Configuration**:
  - Allow POST from mobile/web client origins
  - Allow GET for authenticated users
  - Allow HEAD for pre-signed URL validation
- **Access Control**: Block all public access, only pre-signed URLs and IAM role-based access

### API Gateway Configuration
- **Base URL**: `https://api.companycam.com/v1` or `https://api-{environment}.companycam.com`
- **Authentication**: JWT Bearer token validation on all endpoints except `/health` and `/auth/login`
- **Rate Limiting**:
  - 100 requests per second per user for general endpoints
  - 10 requests per second per user for detection endpoints
- **Request/Response Logging**: CloudWatch Logs with structured JSON format
- **CORS Headers**: Allow origins for mobile and web clients
- **API Versioning**: URL path versioning (`/v1`, `/v2`) [Source: architecture.md#7.1-REST-API-Conventions]

### Redis Configuration
- **Instance Type**:
  - Development: `cache.t3.micro` (small standalone)
  - Production: `cache.r6g.xlarge` in cluster mode with 3 nodes (minimum)
- **Engine Version**: Redis 7.0+
- **Eviction Policy**: `allkeys-lru` for automatic eviction of least-used keys
- **Parameter Group**: Configure connection pooling, timeout settings
- **Subnet Group**: Private subnets only
- **Security Group**: Only allow access from backend services in same VPC

### CloudWatch & Monitoring Setup
- **Log Groups**:
  - `/aws/apigateway/companycam-api`
  - `/aws/ecs/photo-upload-service`
  - `/aws/ecs/detection-service`
  - `/aws/ecs/metadata-service`
- **Retention**: 30 days for development/staging, 90 days for production
- **Metrics**: Enable detailed monitoring (1-minute granularity)
- **Alarms**: Critical service alerts (see architecture.md#11.3-Alerting)

### IAM Roles and Policies
- **S3 Bucket Policy**: Allow specific IAM roles to read/write photos
- **API Gateway Role**: Allow CloudWatch Logs, X-Ray write access
- **Backend Service Roles**:
  - `photo-upload-service-role`: S3 read/write, CloudWatch Logs
  - `detection-service-role`: S3 read, CloudWatch Logs
  - `metadata-service-role`: CloudWatch Logs
- **Cross-Account Access**: If using SageMaker in separate account, configure cross-account IAM role

### VPC and Network Configuration
- **VPC**: Single VPC with CIDR range (e.g., 10.0.0.0/16)
- **Subnets**:
  - 2 public subnets for ALB
  - 4 private subnets for backend services (spread across 2 AZs)
- **Security Groups**:
  - ALB Security Group: Allow HTTP/HTTPS (80, 443) from internet
  - Backend Service SG: Allow traffic from ALB on service ports
  - RDS Security Group: Allow PostgreSQL (5432) from backend services only
  - Redis Security Group: Allow Redis (6379) from backend services only
- **NAT Gateway**: In each public subnet for private subnet internet access

### Terraform File Structure
- `/infrastructure/terraform/main.tf`: AWS provider, backend state configuration
- `/infrastructure/terraform/vpc.tf`: VPC, subnets, security groups, NAT gateways
- `/infrastructure/terraform/s3.tf`: S3 bucket configuration with versioning, encryption, lifecycle, CORS
- `/infrastructure/terraform/api-gateway.tf`: API Gateway configuration with authorization
- `/infrastructure/terraform/redis.tf`: ElastiCache Redis cluster
- `/infrastructure/terraform/cloudwatch.tf`: Log groups, alarms, monitoring
- `/infrastructure/terraform/iam.tf`: IAM roles and policies
- `/infrastructure/terraform/variables.tf`: Environment-specific variables
- `/infrastructure/terraform/outputs.tf`: Important resource IDs and endpoints

### Testing Standards
- **Infrastructure Testing**: Terraform validate, terraform plan review
- **Manual Verification**:
  - Test S3 pre-signed URL generation and upload
  - Verify API Gateway JWT validation rejects invalid tokens
  - Test CORS headers for web/mobile origin
  - Verify Redis connectivity from VPC
- **No automated unit tests** for infrastructure (Terraform modules are external)

---

## Tasks / Subtasks

- [ ] Create Terraform backend and provider configuration (AC: 8)
  - [ ] Initialize Terraform project in `/infrastructure/terraform/`
  - [ ] Configure S3 backend for state management with locking
  - [ ] Create `main.tf` with AWS provider and region configuration
  - [ ] Create `.gitignore` for terraform files (exclude .tfstate)
  - [ ] Document Terraform setup and backend access in README

- [ ] Provision VPC and Network Infrastructure (AC: 6)
  - [ ] Create `vpc.tf` with 1 VPC, 2 public subnets, 4 private subnets across 2 AZs
  - [ ] Configure NAT gateways in public subnets for private subnet internet access
  - [ ] Create security groups: ALB, backend services, RDS, Redis
  - [ ] Set up routing tables and subnet associations
  - [ ] Test VPC connectivity with manual EC2 instance (temporary)

- [ ] Create and Configure S3 Photo Storage Bucket (AC: 1, 2, 3)
  - [ ] Create `s3.tf` Terraform module
  - [ ] Create S3 bucket with naming pattern: `companycam-photos-{environment}`
  - [ ] Enable versioning on bucket
  - [ ] Configure AES-256 encryption (default encryption)
  - [ ] Add lifecycle policies: move to Glacier after 90 days, delete temporary files after 30 days
  - [ ] Configure CORS rules: allow POST/GET from client origins, allow HEAD for validation
  - [ ] Block all public access, require pre-signed URLs or IAM role access
  - [ ] Create bucket policy for service access
  - [ ] Test pre-signed URL generation and uploads locally

- [ ] Set Up API Gateway (AC: 2, 4)
  - [ ] Create `api-gateway.tf` Terraform module
  - [ ] Create API Gateway with base path `/v1`
  - [ ] Configure authentication with JWT validator Lambda
  - [ ] Set up rate limiting: 100 req/s general, 10 req/s detection endpoints
  - [ ] Enable access logging to CloudWatch
  - [ ] Configure CORS headers for mobile/web clients
  - [ ] Test with sample requests (authorized and unauthorized)

- [ ] Provision ElastiCache Redis Cluster (AC: 4, 7)
  - [ ] Create `redis.tf` Terraform module
  - [ ] Create Redis cluster in private subnets across 2 AZs
  - [ ] Configure security group for backend service access only
  - [ ] Set eviction policy to `allkeys-lru`
  - [ ] Configure parameter group with connection pooling settings
  - [ ] Test Redis connectivity from backend services

- [ ] Create CloudWatch Log Groups and Monitoring (AC: 4)
  - [ ] Create `cloudwatch.tf` Terraform module
  - [ ] Create log groups for API Gateway, ECS services
  - [ ] Configure 30-day retention for non-production, 90-day for production
  - [ ] Set up basic CloudWatch metrics and alarms
  - [ ] Enable detailed monitoring (1-minute granularity)
  - [ ] Document monitoring setup and alert thresholds

- [ ] Configure IAM Roles and Policies (AC: 5)
  - [ ] Create `iam.tf` Terraform module
  - [ ] Create S3 bucket access role for backend services
  - [ ] Create CloudWatch Logs role for API Gateway and services
  - [ ] Create service-specific roles for each microservice
  - [ ] Test IAM permissions with actual service calls
  - [ ] Document role purposes and permissions in comments

- [ ] Create Terraform Variables and Outputs (AC: 8)
  - [ ] Create `variables.tf` with environment-specific inputs
  - [ ] Create `outputs.tf` with resource IDs, endpoint URLs, role ARNs
  - [ ] Create `terraform.tfvars` template for different environments
  - [ ] Document all variables and their purposes
  - [ ] Test Terraform plan with different variable sets

- [ ] Documentation and Runbook Creation (AC: 8)
  - [ ] Create `/infrastructure/TERRAFORM_SETUP.md` with initialization instructions
  - [ ] Document AWS resource architecture and relationships
  - [ ] Create troubleshooting guide for common issues
  - [ ] Document manual verification steps for each component
  - [ ] Add disaster recovery procedures

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Initial story creation for AWS infrastructure | Bob (Scrum Master) |

---

## Dev Agent Record

*To be populated by development agent during implementation*

### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes
TBD

### File List
TBD

---

## QA Results

*To be populated by QA agent after development*
