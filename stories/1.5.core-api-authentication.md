# Story 1.5: Core API Endpoints and Authentication

**Status:** Ready for Development

---

## Story

**As a** API Consumer,
**I want** to authenticate with JWT tokens and access core endpoints for health checks, user authentication, and project management,
**so that** I can securely interact with the photo detection system and manage project resources.

---

## Acceptance Criteria

1. JWT token authentication implemented with OAuth 2.0 / OpenID Connect integration capability
2. Login endpoint `/api/v1/auth/login` accepts email/password and returns JWT token with 24-hour expiration
3. Token refresh endpoint `/api/v1/auth/refresh` allows extending token validity without re-authentication
4. Token validation middleware enforces JWT signature verification and token expiration
5. Health check endpoints `/health`, `/api/v1/health` return service status without requiring authentication
6. Project endpoints: `/api/v1/projects` (GET), `/api/v1/projects/{id}` (GET, PATCH) with user authorization
7. Logout endpoint `/api/v1/auth/logout` invalidates tokens (via token blacklist or expiration)
8. Error responses follow RFC 7807 Problem Details format with appropriate HTTP status codes

---

## Dev Notes

### API Authentication Architecture
- **Authentication Method**: OAuth 2.0 Bearer tokens with JWT (JSON Web Tokens) [Source: architecture.md#8.1-Authentication-and-Authorization]
- **Token Format**: JWT with HS256 or RS256 signature
- **Scope**: Service-to-service communication uses mTLS certificates [Source: architecture.md#8.1-Authentication-and-Authorization]
- **API Gateway Integration**: API Gateway validates JWT before routing to backend services [Source: architecture.md#4.2-API-Gateway]

### JWT Token Structure
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_id_uuid",
    "email": "user@companycam.com",
    "organization_id": "org_uuid",
    "role": "contractor",
    "iat": 1700000000,
    "exp": 1700086400,
    "iss": "companycam-api"
  },
  "signature": "HMACSHA256(...)"
}
```

### Authentication Endpoints

#### Login Endpoint
```
POST /api/v1/auth/login
Content-Type: application/json

{
  "email": "contractor@companycam.com",
  "password": "secure_password"
}

Response 200:
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 86400,
  "user": {
    "id": "uuid",
    "email": "contractor@companycam.com",
    "first_name": "John",
    "role": "contractor",
    "organization_id": "uuid"
  }
}

Response 401:
{
  "type": "https://api.companycam.com/errors/unauthorized",
  "title": "Unauthorized",
  "status": 401,
  "detail": "Invalid email or password"
}
```

#### Token Refresh Endpoint
```
POST /api/v1/auth/refresh
Authorization: Bearer {refresh_token}

Response 200:
{
  "access_token": "new_token",
  "token_type": "Bearer",
  "expires_in": 86400
}
```

#### Logout Endpoint
```
POST /api/v1/auth/logout
Authorization: Bearer {access_token}

Response 204: No Content
```

### Core Project Endpoints

#### Get Projects
```
GET /api/v1/projects
Authorization: Bearer {access_token}

Response 200:
{
  "projects": [
    {
      "id": "uuid",
      "name": "Roof Damage Assessment - Q4 2025",
      "description": "...",
      "status": "active",
      "created_at": "2025-11-17T10:00:00Z"
    }
  ]
}
```

#### Get Project Details
```
GET /api/v1/projects/{project_id}
Authorization: Bearer {access_token}

Response 200:
{
  "id": "uuid",
  "name": "...",
  "description": "...",
  "organization_id": "uuid",
  "status": "active",
  "created_at": "2025-11-17T10:00:00Z",
  "photo_count": 42,
  "last_photo_at": "2025-11-17T11:00:00Z"
}
```

#### Update Project
```
PATCH /api/v1/projects/{project_id}
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "name": "Updated Project Name",
  "description": "Updated description"
}

Response 200: {...updated project...}
```

### Health Check Endpoints

#### Basic Health Check
```
GET /health

Response 200:
{
  "status": "healthy",
  "timestamp": "2025-11-17T10:00:00Z"
}
```

#### API Health Check
```
GET /api/v1/health

Response 200:
{
  "status": "healthy",
  "version": "1.0.0",
  "services": {
    "database": "connected",
    "redis": "connected",
    "s3": "connected"
  }
}
```

### API Response Standards
- **Success**: HTTP 200, 201, 204 with JSON response (except 204)
- **Client Errors**: HTTP 400, 401, 403, 404, 409 with problem detail
- **Server Errors**: HTTP 500, 502, 503 with problem detail
- **Format**: RFC 7807 Problem Details for HTTP APIs [Source: architecture.md#7.1-REST-API-Conventions]

### Error Response Format
```json
{
  "type": "https://api.companycam.com/errors/validation_error",
  "title": "Validation Error",
  "status": 400,
  "detail": "Field 'email' is required",
  "instance": "/api/v1/auth/login",
  "errors": [
    {
      "field": "email",
      "message": "Field is required"
    }
  ]
}
```

### Password Security
- **Hashing**: bcrypt with salt rounds ≥ 12
- **Minimum Length**: 8 characters (enforced at client and server)
- **Password Policy**: Enforced (uppercase, lowercase, numbers, special chars - configurable)
- **Rate Limiting**: Max 5 failed login attempts per IP per 15 minutes

### CORS Configuration
- **Allowed Origins**: React/React Native application domains
- **Allowed Methods**: GET, POST, PATCH, DELETE, OPTIONS
- **Allowed Headers**: Content-Type, Authorization
- **Credentials**: Include cookies if session-based auth used
- **Max Age**: 3600 seconds

### Authorization & RBAC
- **Roles**: contractor, insurance_adjuster, project_manager, admin
- **Project Access**:
  - Users can only access projects from their organization
  - Project members have read/write access to project resources
  - Admins can manage project membership
- **Photo Access**:
  - Users can only view photos from projects they access
  - Users can only upload to projects they're members of

### Testing Standards
- **Unit Tests**:
  - Token generation and validation logic
  - Password hashing verification
  - RBAC permission checks
  - Error response formatting
- **Integration Tests**:
  - Full login flow with database user creation
  - Token refresh with valid/invalid tokens
  - Authorization checks (access denied scenarios)
  - Project endpoint access with various roles
  - Health check endpoint responses
- **Security Tests**:
  - Rate limiting on login endpoint
  - Token expiration enforcement
  - Invalid signature rejection
  - SQL injection prevention
- **Test Coverage**: >85% for authentication and authorization logic
- **Test Framework**: Pytest (Python) or Jest (Node.js)

---

## Tasks / Subtasks

- [ ] Implement JWT Token Service (AC: 1, 2)
  - [ ] Create `/backend/src/services/auth_service.py` or `authService.ts`
  - [ ] Implement JWT token generation with configurable expiration (24 hours for access, 7 days for refresh)
  - [ ] Implement JWT token validation and signature verification
  - [ ] Use HS256 or RS256 algorithm with secure key storage (AWS Secrets Manager or .env)
  - [ ] Create functions: generate_token(), validate_token(), decode_token()
  - [ ] Test token generation and validation with various payloads

- [ ] Implement Password Hashing (AC: 2)
  - [ ] Import bcrypt library (Python: bcrypt, Node.js: bcryptjs)
  - [ ] Create password hashing function with salt rounds ≥ 12
  - [ ] Create password verification function
  - [ ] Test hash comparison with correct and incorrect passwords
  - [ ] Document password requirements: 8+ characters

- [ ] Create Authentication Middleware (AC: 4)
  - [ ] Create middleware to extract and validate JWT from Authorization header
  - [ ] Implement token signature verification and expiration check
  - [ ] Return 401 for missing/invalid tokens, 403 for expired tokens
  - [ ] Add request context with user_id, organization_id from token
  - [ ] Create public endpoints list (health, login) that bypass authentication
  - [ ] Test middleware with valid, invalid, and missing tokens

- [ ] Implement Login Endpoint (AC: 1, 2, 8)
  - [ ] Create `POST /api/v1/auth/login` endpoint
  - [ ] Validate email/password input (required fields)
  - [ ] Query database for user by email
  - [ ] Verify password hash matches provided password
  - [ ] Generate access and refresh tokens on success
  - [ ] Return error 401 for invalid credentials (without revealing which field failed)
  - [ ] Implement rate limiting: max 5 failed attempts per IP per 15 minutes
  - [ ] Log authentication attempts (success and failures)
  - [ ] Test with valid credentials, invalid password, non-existent email

- [ ] Implement Token Refresh Endpoint (AC: 3)
  - [ ] Create `POST /api/v1/auth/refresh` endpoint
  - [ ] Accept refresh token in Authorization header
  - [ ] Validate refresh token signature and expiration
  - [ ] Generate new access token
  - [ ] Return new token without requiring re-authentication
  - [ ] Test token refresh with valid and expired refresh tokens

- [ ] Implement Logout Endpoint (AC: 7)
  - [ ] Create `POST /api/v1/auth/logout` endpoint with JWT authentication
  - [ ] Implement token blacklist (store invalidated tokens in Redis)
  - [ ] Set token blacklist expiration to token expiration time
  - [ ] Return 204 No Content on success
  - [ ] Test logout invalidates token for subsequent requests

- [ ] Implement Health Check Endpoints (AC: 5)
  - [ ] Create `GET /health` endpoint (public, no auth required)
  - [ ] Create `GET /api/v1/health` endpoint (public, checks service dependencies)
  - [ ] Health check returns status: healthy, degraded, or unhealthy
  - [ ] Detailed health: check database, Redis, S3 connectivity
  - [ ] Test endpoints with various service states

- [ ] Create Project Endpoints (AC: 6)
  - [ ] Create `GET /api/v1/projects` endpoint with JWT auth
  - [ ] Return all projects for user's organization with pagination
  - [ ] Create `GET /api/v1/projects/{project_id}` endpoint
  - [ ] Verify user has access to project (same organization)
  - [ ] Return 404 if project not found or user lacks access
  - [ ] Create `PATCH /api/v1/projects/{project_id}` for updating project name/description
  - [ ] Validate input and enforce authorization
  - [ ] Test with various roles and access scenarios

- [ ] Implement RBAC and Authorization (AC: 4, 6)
  - [ ] Create authorization decorators/middleware for endpoint protection
  - [ ] Implement role-based access checks (contractor, adjuster, manager, admin)
  - [ ] Implement resource-level access checks (user can only access own organization)
  - [ ] Test authorization with different user roles
  - [ ] Test cross-organization access prevention

- [ ] Implement Error Response Formatting (AC: 8)
  - [ ] Create RFC 7807 Problem Details response formatter
  - [ ] Return appropriate HTTP status codes
  - [ ] Include error type, title, detail, and instance fields
  - [ ] Add validation error details for input validation failures
  - [ ] Test error responses for various scenarios
  - [ ] Ensure sensitive info not exposed in error messages

- [ ] Create Comprehensive Tests (AC: 1-8)
  - [ ] Unit tests for JWT token generation, validation, expiration
  - [ ] Unit tests for password hashing and verification
  - [ ] Integration tests for login flow end-to-end
  - [ ] Integration tests for token refresh and logout
  - [ ] Integration tests for authorization checks
  - [ ] Test health check with all service states
  - [ ] Test rate limiting on login endpoint
  - [ ] Test CORS headers on authenticated endpoints
  - [ ] Achieve >85% test coverage

- [ ] Create API Documentation (AC: 1-8)
  - [ ] Document `/api/v1/auth/login` endpoint with example requests/responses
  - [ ] Document `/api/v1/auth/refresh` endpoint
  - [ ] Document `/api/v1/auth/logout` endpoint
  - [ ] Document `/api/v1/projects` endpoints with authorization notes
  - [ ] Document error codes and problem detail examples
  - [ ] Add authentication flow diagram
  - [ ] Create SDK examples for client integration

- [ ] Implement Security Best Practices (AC: 4, 8)
  - [ ] Add HTTPS requirement (TLS 1.3)
  - [ ] Add security headers: HSTS, X-Content-Type-Options, X-Frame-Options, CSP
  - [ ] Implement CSRF protection if using session cookies
  - [ ] Add request ID generation for tracing
  - [ ] Log security events (failed auth, authorization failures)
  - [ ] Document security considerations in README

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Initial story creation for core API and authentication | Bob (Scrum Master) |

---

## Dev Agent Record

*To be populated by development agent during implementation*

### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes
TBD

### File List
TBD

---

## QA Results

*To be populated by QA agent after development*
