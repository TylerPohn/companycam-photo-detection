# Story 1.3: Database Schema and Models

**Status:** Ready for Development

---

## Story

**As a** Backend Developer,
**I want** to design and implement the PostgreSQL database schema and ORM models for photos, detections, tags, and metadata,
**so that** we have a reliable, normalized data structure to store photo uploads, detection results, and user confirmations.

---

## Acceptance Criteria

1. PostgreSQL database created with proper extensions (UUID, JSON, TimescaleDB for time-series data)
2. Core tables implemented: `photos`, `detections`, `tags`, `users`, `projects` with proper relationships and indexes
3. SQLAlchemy ORM models (if Python) or Typeorm/Sequelize models (if Node.js) created and tested
4. Database migrations framework configured (Alembic for SQLAlchemy or TypeORM migrations)
5. Relationships validated: photos → detections (1:many), photos → tags (many:many), detections → feedback
6. Primary key and foreign key constraints properly enforced
7. Indexes created on frequently queried columns: photo_id, user_id, project_id, created_at
8. Row-level security or schema isolation implemented for multi-tenant data isolation

---

## Dev Notes

### Database Schema Design
- **DBMS**: PostgreSQL with ACID compliance and JSONB support [Source: architecture.md#6.1-Backend-Services]
- **Data Models**: Photo metadata, detection results, tags, and user confirmations [Source: architecture.md#4.7-Metadata-Service]
- **Time-Series Data**: Detection timestamps and processing history benefit from TimescaleDB extension for efficient time-range queries
- **JSON Support**: JSONB columns for flexible detection results storage and EXIF data

### Core Data Models

#### Users Table
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  role VARCHAR(50) DEFAULT 'contractor',  -- contractor, insurance_adjuster, project_manager
  organization_id UUID NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (organization_id) REFERENCES organizations(id)
);
```

#### Organizations Table
```sql
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(name)
);
```

#### Projects Table
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  status VARCHAR(50) DEFAULT 'active',  -- active, completed, archived
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (organization_id) REFERENCES organizations(id)
);
```

#### Photos Table
```sql
CREATE TABLE photos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  project_id UUID NOT NULL,
  s3_url TEXT NOT NULL,
  s3_key VARCHAR(500),  -- For reference and deletion
  file_size_bytes INTEGER,
  mime_type VARCHAR(50),
  width INTEGER,
  height INTEGER,
  exif_data JSONB,  -- Camera metadata, GPS, timestamp
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (project_id) REFERENCES projects(id),
  INDEX photos_user_id_idx ON (user_id),
  INDEX photos_project_id_idx ON (project_id),
  INDEX photos_created_at_idx ON (created_at)
);
```

#### Detections Table
```sql
CREATE TABLE detections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  photo_id UUID NOT NULL,
  detection_type VARCHAR(50) NOT NULL,  -- damage, material, volume
  model_version VARCHAR(100),
  results JSONB NOT NULL,  -- JSON structure with confidence, bounding boxes, etc.
  confidence FLOAT,
  processing_time_ms INTEGER,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  user_confirmed BOOLEAN DEFAULT FALSE,
  user_feedback JSONB,  -- User corrections and confirmations
  FOREIGN KEY (photo_id) REFERENCES photos(id) ON DELETE CASCADE,
  INDEX detections_photo_id_idx ON (photo_id),
  INDEX detections_type_idx ON (detection_type),
  INDEX detections_created_at_idx ON (created_at)
);
```

#### Tags Table
```sql
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  photo_id UUID NOT NULL,
  tag VARCHAR(100) NOT NULL,
  source VARCHAR(20) DEFAULT 'ai',  -- ai, user
  confidence FLOAT,  -- NULL if user-generated, confidence score if AI-generated
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (photo_id) REFERENCES photos(id) ON DELETE CASCADE,
  INDEX tags_photo_id_idx ON (photo_id),
  INDEX tags_tag_idx ON (tag)
);
```

### ORM Framework Choice
- **Python**: SQLAlchemy 2.0+ with Pydantic for validation
  - Models location: `/backend/src/models/`
  - Database session management via dependency injection
  - Migration tool: Alembic
- **Node.js**: TypeORM or Sequelize
  - Models location: `/backend/src/entities/`
  - Decorators for relationship definitions
  - Built-in migration support

### Database Constraints and Validations
- **Foreign Key Constraints**: CASCADE delete for detections/tags when photo deleted
- **Unique Constraints**: User email, photo S3 key, project name per organization
- **Check Constraints**: Confidence scores between 0-1, processing time > 0
- **Not Null**: Essential fields like user_id, project_id, s3_url, detection_type

### Indexing Strategy
- **Primary Indexes**:
  - Photos: user_id, project_id, created_at (for filtering by user and date)
  - Detections: photo_id, detection_type, created_at
  - Tags: photo_id, tag (for search and filtering)
- **Composite Indexes** (future optimization):
  - (project_id, created_at) for project-level analytics
  - (detection_type, user_confirmed) for filtering unconfirmed detections
- **Partial Indexes**: On user_confirmed = FALSE for faster queries on pending confirmations

### Testing Standards
- **Database Tests**: Integration tests with test PostgreSQL instance
- **ORM Model Tests**: Validate relationships, constraints, validations
- **Migration Tests**: Test forward and backward migrations
- **Test Data Setup**: Fixtures for users, projects, photos, detections
- **Coverage**: Test all model relationships and validation rules >80%
- **Cleanup**: Transactions rolled back after each test to isolate changes

---

## Tasks / Subtasks

- [ ] Set up PostgreSQL and Extensions (AC: 1)
  - [ ] Create PostgreSQL instance (development: local Docker container)
  - [ ] Enable required extensions: `uuid-ossp` or `pgcrypto`, `json`, `jsonb_operations`
  - [ ] Create database schema: `companycam_photos`
  - [ ] Set up user roles with minimal permissions (dev, test, prod users)
  - [ ] Test connection string and permissions

- [ ] Design and Create Core Tables (AC: 2, 6, 7)
  - [ ] Create `organizations` table
  - [ ] Create `users` table with organization foreign key
  - [ ] Create `projects` table with organization foreign key
  - [ ] Create `photos` table with user and project foreign keys
  - [ ] Create `detections` table with photo foreign key and JSONB results
  - [ ] Create `tags` table with photo foreign key
  - [ ] Verify all foreign key constraints and ON DELETE CASCADE behavior

- [ ] Create Database Indexes (AC: 7)
  - [ ] Add index on photos(user_id)
  - [ ] Add index on photos(project_id)
  - [ ] Add index on photos(created_at)
  - [ ] Add index on detections(photo_id)
  - [ ] Add index on detections(detection_type)
  - [ ] Add index on detections(created_at)
  - [ ] Add index on tags(photo_id)
  - [ ] Add index on tags(tag)
  - [ ] Document indexing strategy and justify each index

- [ ] Implement ORM Models (AC: 2, 3)
  - [ ] Create SQLAlchemy/TypeORM base model with common fields (id, created_at, updated_at)
  - [ ] Implement User model with relationships to projects
  - [ ] Implement Photo model with relationships to user, project, detections, tags
  - [ ] Implement Detection model with JSON schema for results JSONB
  - [ ] Implement Tag model with enum for source (ai, user)
  - [ ] Add model-level validations for confidence scores, timestamps
  - [ ] Test model instantiation and relationship loading

- [ ] Configure Database Migrations (AC: 4)
  - [ ] Set up Alembic (if Python) or TypeORM migrations (if Node.js)
  - [ ] Create initial migration: create all tables and relationships
  - [ ] Test forward migration (create tables)
  - [ ] Test backward migration (drop tables)
  - [ ] Document migration process and adding future migrations

- [ ] Implement Row-Level Security (AC: 8)
  - [ ] Create PostgreSQL roles: org_admin, org_user with specific permissions
  - [ ] Implement RLS policies:
    - Users can only see photos from their organization
    - Users can only see projects they're members of
  - [ ] Test RLS policies prevent cross-organization data leakage
  - [ ] Document RLS policies and audit processes

- [ ] Write Integration Tests (AC: 2, 5, 6, 7)
  - [ ] Create test fixtures: sample users, organizations, projects, photos
  - [ ] Test table creation and schema integrity
  - [ ] Test foreign key relationships and cascading deletes
  - [ ] Test ORM model relationships (loading related objects)
  - [ ] Test unique and check constraints enforcement
  - [ ] Test index effectiveness with sample queries (execution plans)
  - [ ] Achieve >80% test coverage for models

- [ ] Create Database Documentation (AC: 2, 8)
  - [ ] Document ER diagram (relationships between tables)
  - [ ] Create data dictionary (purpose of each table and column)
  - [ ] Document JSONB schema for detections results field
  - [ ] Create setup guide for new developers
  - [ ] Document backup and recovery procedures

- [ ] Set Up Development and Test Databases (AC: 2)
  - [ ] Configure Docker Compose to spawn PostgreSQL for development
  - [ ] Create seed scripts for sample data (organizations, projects, users)
  - [ ] Set up test database with automatic cleanup between test runs
  - [ ] Document database connection strings for different environments

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Initial story creation for database schema | Bob (Scrum Master) |

---

## Dev Agent Record

*To be populated by development agent during implementation*

### Agent Model Used
TBD

### Debug Log References
TBD

### Completion Notes
TBD

### File List
TBD

---

## QA Results

*To be populated by QA agent after development*
